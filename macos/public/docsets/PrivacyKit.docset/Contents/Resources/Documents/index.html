<!DOCTYPE html>
<html lang="en">
  <head>
    <title>PrivacyKit  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
    <script src="js/lunr.min.js" defer></script>
    <script src="js/typeahead.jquery.js" defer></script>
    <script src="js/jazzy.search.js" defer></script>
  </head>
  <body>


    <a title="PrivacyKit  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
          PrivacyKit Docs
        </a>
         (100% documented)
      </p>
    
      <p class="header-col--secondary">
        <form role="search" action="search.json">
          <input type="text" placeholder="Search documentation" data-typeahead>
        </form>
      </p>
    
        <p class="header-col header-col--secondary">
          <a class="header-link" href="https://github.com/AppPETs/PrivacyKit">
            <img class="header-icon" src="img/gh.png"/>
            View on GitHub
          </a>
        </p>
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html">PrivacyKit Reference</a>
      <img class="carat" src="img/carat.png" />
      PrivacyKit  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ConfidentialQrCodeView.html">ConfidentialQrCodeView</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Http.html">Http</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Http/Error.html">– Error</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Http/Method.html">– Method</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Http/StatusCategory.html">– StatusCategory</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Http/Status.html">– Status</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Http/Header.html">– Header</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Http/ContentType.html">– ContentType</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Http.html#/s:10PrivacyKit4HttpC7MessageC">– Message</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Http.html#/s:10PrivacyKit4HttpC7RequestC">– Request</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Http.html#/s:10PrivacyKit4HttpC8ResponseC">– Response</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Indicators.html">Indicators</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/PrivacyService.html">PrivacyService</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/RegularExpression.html">RegularExpression</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SecureKeyValueStorage.html">SecureKeyValueStorage</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SecureKeyValueStorage/Error.html">– Error</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/Shalon.html">Shalon</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/ShalonURLProtocol.html">ShalonURLProtocol</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Enums.html">Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/AuthenticationError.html">AuthenticationError</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/EncryptedKey.html">EncryptedKey</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/HTTPURLResponse.html">HTTPURLResponse</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/MasterKey.html">MasterKey</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/URLRequest.html">URLRequest</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Functions.html">Functions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Functions.html#/s:10PrivacyKit2etoiSbSS_AA17RegularExpressionCtF">=~(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Functions.html#/s:10PrivacyKit2etoiSbSS_SStF">=~(_:_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Functions.html#/s:10PrivacyKit23authenticateDeviceOwnerSo9LAContextCSS6reason_yAA19AuthenticationErrorOSgc10completiontF">authenticateDeviceOwner(reason:completion:)</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/KeyValueStorage.html">KeyValueStorage</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Structs.html">Structures</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Target.html">Target</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Typealiases.html">Type Aliases</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Typealiases.html#/s:10PrivacyKit21AuthenticationContexta">AuthenticationContext</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Typealiases.html#/Image">Image</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Typealiases.html#/s:10PrivacyKit5Imagea">Image</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Typealiases.html#/ImageView">ImageView</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Typealiases.html#/s:10PrivacyKit9ImageViewa">ImageView</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content">
            
            <h1 id='privacykit' class='heading'>PrivacyKit</h1>

<p><a href="https://travis-ci.org/AppPETs/PrivacyKit"><img src="https://travis-ci.org/AppPETs/PrivacyKit.svg?branch=master" alt="Build Status"></a> <a href="https://apppets.github.io/PrivacyKit/macos/coverage/index.html"><img src="https://apppets.github.io/PrivacyKit/macos/coverage.svg" alt="Coverage"></a> <a href="https://apppets.github.io/PrivacyKit"><img src="https://apppets.github.io/PrivacyKit/macos/public/badge.svg" alt="Documentation"></a></p>

<p>The <code>PrivacyKit</code> is a framework for iOS that provides functionality to handle personal information appropriately.</p>

<ul>
<li>Repository: <a href="https://github.com/AppPETs/PrivacyKit">https://github.com/AppPETs/PrivacyKit</a></li>
<li>Documentation: <a href="https://apppets.github.io/PrivacyKit">https://apppets.github.io/PrivacyKit</a>

<ul>
<li>macOS: <a href="https://apppets.github.io/PrivacyKit/macos/public">public</a>, <a href="https://apppets.github.io/PrivacyKit/macos/internal">internal</a>, <a href="https://apppets.github.io/PrivacyKit/macos/private">private</a></li>
<li>iOS: <a href="https://apppets.github.io/PrivacyKit/iphone/public">public</a>, <a href="https://apppets.github.io/PrivacyKit/iphone/internal">internal</a>, <a href="https://apppets.github.io/PrivacyKit/iphone/private">private</a></li>
</ul></li>
<li>Issues: <a href="https://github.com/AppPETs/PrivacyKit/issues">https://github.com/AppPETs/PrivacyKit/issues</a></li>
</ul>

<p>A proof-of-concept Implementation of privacy services can be found at <a href="https://github.com/AppPETs/PrivacyService">https://github.com/AppPETs/PrivacyService</a>.</p>
<h2 id='functionality' class='heading'>Functionality</h2>

<p>Several technologies can be used to enhance privacy, also known as privacy-enhancing technologies (PETs). Many PETs are known in research, but are not easily available to developers. The goal of this project is to make PETs accessible to app developers. The following functionality has been implemented in a way that it can be easily used by application developers.</p>
<h3 id='storing-credentials' class='heading'>Storing Credentials</h3>

<p>Storing credentials is not as easy as it sounds. Many applications do this wrong and store a password for authenticating a user in plaintext or cryptographic key alongside the encrypted data. It is better to use the credential storage offered by iOS, the <a href="https://developer.apple.com/documentation/security/keychain_services">Keychain services</a>. Credentials stored there are encrypted by the Secure Enclave¹. Unfortunately the Keychain services are only accessible by a low-level API, with insufficient documentation, convenience APIs for different tasks have been added.</p>
<h4 id='passwords-for-authentication' class='heading'>Passwords for Authentication</h4>

<p>If the goal ist to simply authenticate the user, by validating if he knows a previously set password, then the <a href="https://blochberger.github.io/Tafelsalz/macos/public/Classes/Password.html"><code>Password</code></a> class of the <a href="https://blochberger.github.io/Tafelsalz">Tafelsalz</a> project should be used. The password must not be stored. A hash generated by a password hashing function should be stored instead. The stored hash keeps the actual password secret and protects against leaks. For authenticating the user via Touch-ID, Face-ID or similar, see the <em>Authenticate Device Owner</em> section.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">password</span> <span class="o">=</span> <span class="kt">Password</span><span class="p">(</span><span class="s">"Correct Horse Battery Staple"</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">hashedPassword</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="nf">hash</span><span class="p">()</span><span class="o">!</span>

<span class="c1">// Store `hashedPassword.string` to database.</span>

<span class="c1">// If a user wants to authenticate, just read it from the database and</span>
<span class="c1">// verify it against the password given by the user.</span>
<span class="k">if</span> <span class="n">hashedPassword</span><span class="o">.</span><span class="nf">isVerified</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// The user is authenticated successfully.</span>
<span class="p">}</span>
</code></pre>
<h4 id='passwords-for-later-use' class='heading'>Passwords for Later Use</h4>

<p>If the goal is to store a password, which later is used, e.g., to authenticate a user to a third-party web service, the password can be stored inside the system&rsquo;s Keychain, by using the <a href="https://blochberger.github.io/Keychain"><code>Keychain</code></a> project.</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">Keychain</span>

<span class="k">let</span> <span class="nv">account</span> <span class="o">=</span> <span class="s">"user"</span> <span class="c1">// A user account, for which the password is used</span>
<span class="k">let</span> <span class="nv">service</span> <span class="o">=</span> <span class="s">"service"</span> <span class="c1">// A service, e.g., your app name</span>
<span class="k">let</span> <span class="nv">label</span> <span class="o">=</span> <span class="s">"</span><span class="se">\(</span><span class="n">account</span><span class="se">)</span><span class="s">@</span><span class="se">\(</span><span class="n">service</span><span class="se">)</span><span class="s">"</span> <span class="c1">// Descriptive name</span>

<span class="k">let</span> <span class="nv">item</span> <span class="o">=</span> <span class="kt">GenericPasswordItem</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">service</span><span class="p">,</span> <span class="nv">using</span><span class="p">:</span> <span class="n">account</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="n">label</span><span class="p">)</span>

<span class="c1">// Store password</span>
<span class="k">try</span> <span class="kt">Keychain</span><span class="o">.</span><span class="nf">store</span><span class="p">(</span><span class="nv">password</span><span class="p">:</span> <span class="s">"foo"</span><span class="p">,</span> <span class="nv">in</span><span class="p">:</span> <span class="n">item</span><span class="p">)</span>

<span class="c1">// Retrieve password</span>
<span class="k">let</span> <span class="nv">password</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">Keychain</span><span class="o">.</span><span class="nf">retrievePassword</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">item</span><span class="p">)</span>

<span class="c1">// Update password</span>
<span class="k">try</span> <span class="kt">Keychain</span><span class="o">.</span><span class="nf">update</span><span class="p">(</span><span class="nv">password</span><span class="p">:</span> <span class="s">"bar"</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">item</span><span class="p">)</span>

<span class="c1">// Delete item</span>
<span class="k">try</span> <span class="kt">Keychain</span><span class="o">.</span><span class="nf">delete</span><span class="p">(</span><span class="nv">item</span><span class="p">:</span> <span class="n">item</span><span class="p">)</span>
</code></pre>
<h4 id='cryptographic-keys' class='heading'>Cryptographic Keys</h4>

<p>If your goal is to store cryptographic keys, you can either use the <a href="https://blochberger.github.io/Keychain"><code>Keychain</code></a> project directly, or use the <a href="https://blochberger.github.io/Tafelsalz/macos/public/Classes/Persona.html"><code>Persona</code></a> class of the <a href="https://blochberger.github.io/Tafelsalz/">Tafelsalz</a> project.</p>
<pre class="highlight swift"><code><span class="c1">// Create a persona</span>
<span class="k">let</span> <span class="nv">alice</span> <span class="o">=</span> <span class="kt">Persona</span><span class="p">(</span><span class="nv">uniqueName</span><span class="p">:</span> <span class="s">"Alice"</span><span class="p">)</span>

<span class="c1">// Once a secret of that persona is used, it will be persisted in the</span>
<span class="c1">// system's Keychain.</span>
<span class="k">let</span> <span class="nv">secretBox</span> <span class="o">=</span> <span class="kt">SecretBox</span><span class="p">(</span><span class="nv">persona</span><span class="p">:</span> <span class="n">alice</span><span class="p">)</span><span class="o">!</span>

<span class="c1">// Use your SecretBox as usual</span>
<span class="k">let</span> <span class="nv">plaintext</span> <span class="o">=</span> <span class="s">"Hello, World!"</span><span class="o">.</span><span class="n">utf8Bytes</span>
<span class="k">let</span> <span class="nv">ciphertext</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nv">plaintext</span><span class="p">:</span> <span class="n">plaintext</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">decrypted</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="nv">ciphertext</span><span class="p">:</span> <span class="n">ciphertext</span><span class="p">)</span><span class="o">!</span>

<span class="c1">// Forget the persona and remove all related Keychain entries</span>
<span class="k">try!</span> <span class="kt">Persona</span><span class="o">.</span><span class="nf">forget</span><span class="p">(</span><span class="n">alice</span><span class="p">)</span>
</code></pre>
<h3 id='encryption-and-decryption' class='heading'>Encryption and Decryption</h3>

<p>Encryption and decryption can be done by using the <a href="https://blochberger.github.io/Tafelsalz/">Tafelsalz</a> project.</p>

<p>Note that asymmetric encryption as well as stream encryption are not supported, yet (see <a href="https://github.com/blochberger/Tafelsalz/issues/2">https://github.com/blochberger/Tafelsalz/issues/2</a>, <a href="https://github.com/blochberger/Tafelsalz/issues/5">https://github.com/blochberger/Tafelsalz/issues/5</a>).</p>
<h4 id='symmetric-encryption' class='heading'>Symmetric Encryption</h4>
<h4 id='ephemeral-keys' class='heading'>Ephemeral Keys</h4>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">secretBox</span> <span class="o">=</span> <span class="kt">SecretBox</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">plaintext</span> <span class="o">=</span> <span class="s">"Hello, World!"</span><span class="o">.</span><span class="n">utf8Bytes</span>
<span class="k">let</span> <span class="nv">ciphertext</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nv">plaintext</span><span class="p">:</span> <span class="n">plaintext</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">decrypted</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="nv">ciphertext</span><span class="p">:</span> <span class="n">ciphertext</span><span class="p">)</span><span class="o">!</span>
</code></pre>
<h5 id='persisted-keys' class='heading'>Persisted Keys</h5>

<p>The cryptographic keys in this example are stored within the system&rsquo;s  Keychain. See <em>Cryptographic Keys</em> for details.</p>
<pre class="highlight swift"><code><span class="c1">// Create a persona</span>
<span class="k">let</span> <span class="nv">alice</span> <span class="o">=</span> <span class="kt">Persona</span><span class="p">(</span><span class="nv">uniqueName</span><span class="p">:</span> <span class="s">"Alice"</span><span class="p">)</span>

<span class="c1">// Once a secret of that persona is used, it will be persisted in the</span>
<span class="c1">// system's Keychain.</span>
<span class="k">let</span> <span class="nv">secretBox</span> <span class="o">=</span> <span class="kt">SecretBox</span><span class="p">(</span><span class="nv">persona</span><span class="p">:</span> <span class="n">alice</span><span class="p">)</span><span class="o">!</span>

<span class="c1">// Use your SecretBox as usual</span>
<span class="k">let</span> <span class="nv">plaintext</span> <span class="o">=</span> <span class="s">"Hello, World!"</span><span class="o">.</span><span class="n">utf8Bytes</span>
<span class="k">let</span> <span class="nv">ciphertext</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nv">plaintext</span><span class="p">:</span> <span class="n">plaintext</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">decrypted</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="nv">ciphertext</span><span class="p">:</span> <span class="n">ciphertext</span><span class="p">)</span><span class="o">!</span>

<span class="c1">// Forget the persona and remove all related Keychain entries</span>
<span class="k">try!</span> <span class="kt">Persona</span><span class="o">.</span><span class="nf">forget</span><span class="p">(</span><span class="n">alice</span><span class="p">)</span>
</code></pre>
<h5 id='padding' class='heading'>Padding</h5>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">secretBox</span> <span class="o">=</span> <span class="kt">SecretBox</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">plaintext</span> <span class="o">=</span> <span class="s">"Hello, World!"</span><span class="o">.</span><span class="n">utf8Bytes</span>
<span class="k">let</span> <span class="nv">padding</span><span class="p">:</span> <span class="kt">Padding</span> <span class="o">=</span> <span class="o">.</span><span class="nf">padded</span><span class="p">(</span><span class="nv">blockSize</span><span class="p">:</span> <span class="mi">16</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">ciphertext</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="nv">plaintext</span><span class="p">:</span> <span class="n">plaintext</span><span class="p">,</span> <span class="nv">padding</span><span class="p">:</span> <span class="n">padding</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">decrypted</span> <span class="o">=</span> <span class="n">secretBox</span><span class="o">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="nv">ciphertext</span><span class="p">:</span> <span class="n">ciphertext</span><span class="p">,</span> <span class="nv">padding</span><span class="p">:</span> <span class="n">padding</span><span class="p">)</span><span class="o">!</span>
</code></pre>
<h5 id='password-hashing' class='heading'>Password Hashing</h5>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">password</span> <span class="o">=</span> <span class="kt">Password</span><span class="p">(</span><span class="s">"Correct Horse Battery Staple"</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">hashedPassword</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="nf">hash</span><span class="p">()</span><span class="o">!</span>

<span class="c1">// Store `hashedPassword.string` to database.</span>

<span class="c1">// If a user wants to authenticate, just read it from the database and</span>
<span class="c1">// verify it against the password given by the user.</span>
<span class="k">if</span> <span class="n">hashedPassword</span><span class="o">.</span><span class="nf">isVerified</span><span class="p">(</span><span class="nv">by</span><span class="p">:</span> <span class="n">password</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// The user is authenticated successfully.</span>
<span class="p">}</span>
</code></pre>
<h4 id='generic-hashing' class='heading'>Generic Hashing</h4>
<h5 id='public-hashing' class='heading'>Public Hashing</h5>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="s">"Hello, World!"</span><span class="o">.</span><span class="n">utf8Bytes</span>
<span class="k">let</span> <span class="nv">hash</span> <span class="o">=</span> <span class="kt">GenericHash</span><span class="p">(</span><span class="nv">bytes</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
</code></pre>
<h5 id='private-hashing-with-persisted-keys' class='heading'>Private Hashing with Persisted Keys</h5>
<pre class="highlight swift"><code><span class="c1">// Create a persona</span>
<span class="k">let</span> <span class="nv">alice</span> <span class="o">=</span> <span class="kt">Persona</span><span class="p">(</span><span class="nv">uniqueName</span><span class="p">:</span> <span class="s">"Alice"</span><span class="p">)</span>

<span class="c1">// Generate a personalized hash for that persona</span>
<span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="s">"Hello, World!"</span><span class="o">.</span><span class="n">utf8Bytes</span>
<span class="k">let</span> <span class="nv">hash</span> <span class="o">=</span> <span class="kt">GenericHash</span><span class="p">(</span><span class="nv">bytes</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">alice</span><span class="p">)</span>

<span class="c1">// Forget the persona and remove all related Keychain entries</span>
<span class="k">try!</span> <span class="kt">Persona</span><span class="o">.</span><span class="nf">forget</span><span class="p">(</span><span class="n">alice</span><span class="p">)</span>
</code></pre>
<h4 id='key-derivation' class='heading'>Key Derivation</h4>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">context</span> <span class="o">=</span> <span class="kt">MasterKey</span><span class="o">.</span><span class="kt">Context</span><span class="p">(</span><span class="s">"Examples"</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">masterKey</span> <span class="o">=</span> <span class="kt">MasterKey</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">subKey1</span> <span class="o">=</span> <span class="n">masterKey</span><span class="o">.</span><span class="nf">derive</span><span class="p">(</span><span class="nv">sizeInBytes</span><span class="p">:</span> <span class="kt">MasterKey</span><span class="o">.</span><span class="kt">DerivedKey</span><span class="o">.</span><span class="kt">MinimumSizeInBytes</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">and</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">subKey2</span> <span class="o">=</span> <span class="n">masterKey</span><span class="o">.</span><span class="nf">derive</span><span class="p">(</span><span class="nv">sizeInBytes</span><span class="p">:</span> <span class="kt">MasterKey</span><span class="o">.</span><span class="kt">DerivedKey</span><span class="o">.</span><span class="kt">MinimumSizeInBytes</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">and</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span><span class="o">!</span>

<span class="c1">// You can also derive a key in order to use it with secret boxes</span>
<span class="k">let</span> <span class="nv">secretBox</span> <span class="o">=</span> <span class="kt">SecretBox</span><span class="p">(</span><span class="nv">secretKey</span><span class="p">:</span> <span class="n">masterKey</span><span class="o">.</span><span class="nf">derive</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">and</span><span class="p">:</span> <span class="n">context</span><span class="p">))</span>
</code></pre>
<h4 id='key-exchange' class='heading'>Key Exchange</h4>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">alice</span> <span class="o">=</span> <span class="kt">KeyExchange</span><span class="p">(</span><span class="nv">side</span><span class="p">:</span> <span class="o">.</span><span class="n">client</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">bob</span> <span class="o">=</span> <span class="kt">KeyExchange</span><span class="p">(</span><span class="nv">side</span><span class="p">:</span> <span class="o">.</span><span class="n">server</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">alicesSessionKey</span> <span class="o">=</span> <span class="n">alice</span><span class="o">.</span><span class="nf">sessionKey</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">bob</span><span class="o">.</span><span class="n">publicKey</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">bobsSessionKey</span> <span class="o">=</span> <span class="n">bob</span><span class="o">.</span><span class="nf">sessionKey</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">alice</span><span class="o">.</span><span class="n">publicKey</span><span class="p">)</span>

<span class="c1">// alicesSessionKey == bobsSessionKey</span>
</code></pre>

<p>There is a demo application available for iOS, which shows how to exchange secrets between two devices, using the key exchange mechanism with QR codes, see <a href="https://github.com/AppPETs/SecretSharing-iOS">SecretSharing-iOS</a>.</p>
<h3 id='anonymous-communication' class='heading'>Anonymous Communication</h3>

<p>In order to protect the identity of users from network attackers or curious server operators an anonymization mechanism is offered as well. It is based on Shalon². Note that there are other services, which provide a higher degree of anonymity, such as <a href="https://www.torproject.org">Tor</a>.</p>

<p>In order to use a proxy server as a Shalon proxy, the proxy server itself needs to support TLS, see <a href="https://github.com/AppPETs/PrivacyKit/wiki/ShalonServerConfiguration">Shalon Server Configuration</a>. A demo service is provided at <code>shalon1.jondonym.net</code>.</p>

<p>The implementation works seamlessly with the default URL loading system of iOS and macOS by using a custom URL protocol (<a href="https://apppets.github.io/PrivacyKit/iphone/public/Classes/ShalonURLProtocol.html"><code><a href="Classes/ShalonURLProtocol.html">ShalonURLProtocol</a></code></a>). One first needs to register the URL protocol. After that, URLs of the format <code>httpss://proxy:port/target:port/index.html</code> can be used to connect through <code>proxy</code> on <code>port</code> to <code>https://target:port/index.html</code>. To use more than one proxy (up to three), e.g., use <code>httpssss://proxy1/proxy2/proxy3/target/index.html</code> for connecting via three proxies.</p>
<pre class="highlight swift"><code><span class="c1">// Register the URL protocol</span>
<span class="k">let</span> <span class="nv">configuration</span> <span class="o">=</span> <span class="kt">URLSessionConfiguration</span><span class="o">.</span><span class="n">ephemeral</span>
<span class="n">configuration</span><span class="o">.</span><span class="n">protocolClasses</span><span class="p">?</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="kt">ShalonURLProtocol</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>

<span class="c1">// Use Shalon URLs like you would use any other</span>
<span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="p">(</span><span class="nv">configuration</span><span class="p">:</span> <span class="n">configuration</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"httpss://shalon1.jondonym.net/example.com/"</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">task</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">optionalUrl</span><span class="p">,</span> <span class="n">optionalResponse</span><span class="p">,</span> <span class="n">optionalError</span> <span class="k">in</span>

    <span class="c1">// Handle response</span>
<span class="p">}</span>
</code></pre>

<p>One can also use the <a href="https://apppets.github.io/PrivacyKit/iphone/public/Classes/Shalon.html"><code><a href="Classes/Shalon.html">Shalon</a></code></a> class directly, which gives slightly more control over the HTTP data sent to the target server, e.g., the <code>User-Agent</code> header can not be dropped when using URL sessions.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">proxy1</span> <span class="o">=</span> <span class="kt">Target</span><span class="p">(</span><span class="nv">withHostname</span><span class="p">:</span> <span class="s">"shalon1.jondonym.net"</span><span class="p">,</span> <span class="nv">andPort</span><span class="p">:</span> <span class="mi">443</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">target</span> <span class="o">=</span> <span class="kt">Target</span><span class="p">(</span><span class="nv">withHostname</span><span class="p">:</span> <span class="s">"www.example.com"</span><span class="p">,</span> <span class="nv">andPort</span><span class="p">:</span> <span class="mi">443</span><span class="p">)</span><span class="o">!</span>

<span class="k">let</span> <span class="nv">shalon</span> <span class="o">=</span> <span class="kt">Shalon</span><span class="p">(</span><span class="nv">withTarget</span><span class="p">:</span> <span class="n">target</span><span class="p">)</span>

<span class="n">shalon</span><span class="o">.</span><span class="nf">addLayer</span><span class="p">(</span><span class="n">proxy1</span><span class="p">)</span>

<span class="n">shalon</span><span class="o">.</span><span class="nf">issue</span><span class="p">(</span><span class="nv">request</span><span class="p">:</span> <span class="kt">Request</span><span class="p">(</span><span class="nv">withMethod</span><span class="p">:</span> <span class="o">.</span><span class="n">head</span><span class="p">,</span> <span class="nv">andUrl</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span><span class="o">!</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">optionalResponse</span><span class="p">,</span> <span class="n">optionalError</span> <span class="k">in</span>

    <span class="c1">// Handle response</span>
<span class="p">}</span>
</code></pre>
<h3 id='key-value-storage' class='heading'>Key-value Storage</h3>

<p>A simple key-value storage is offered, where keys and values are protected in a way, that different users, can store key-value pairs in a shared memory without any access control. A demo service is implemented by the <a href="https://github.com/AppPETs/PrivacyService">PrivacyService</a> project.</p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"httpss://shalon1.jondonym.net:443/services.app-pets.org"</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">alice</span> <span class="o">=</span> <span class="kt">Persona</span><span class="p">(</span><span class="nv">uniqueName</span><span class="p">:</span> <span class="s">"alice"</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">context</span> <span class="o">=</span> <span class="kt">SecureKeyValueStorage</span><span class="o">.</span><span class="kt">Context</span><span class="p">(</span><span class="s">"TODOLIST"</span><span class="p">)</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">privacyService</span> <span class="o">=</span> <span class="kt">PrivacyService</span><span class="p">(</span><span class="nv">baseUrl</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">storage</span> <span class="o">=</span> <span class="kt">SecureKeyValueStorage</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">privacyService</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">persona</span><span class="p">,</span> <span class="nv">context</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span><span class="o">!</span>

<span class="c1">// Store something</span>
<span class="n">storage</span><span class="o">.</span><span class="nf">store</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="s">"My PIN"</span><span class="p">,</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Data</span><span class="p">(</span><span class="s">"1234"</span><span class="o">.</span><span class="n">utf8</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">optionalError</span> <span class="k">in</span>

    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">optionalError</span> <span class="p">{</span>
        <span class="c1">// TODO Handle error</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Retrieve something</span>
<span class="n">storage</span><span class="o">.</span><span class="nf">retrieve</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="s">"My PIN"</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">optionalValue</span><span class="p">,</span> <span class="n">optionalError</span> <span class="k">in</span>

    <span class="nf">precondition</span><span class="p">((</span><span class="n">optionalValue</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">optionalError</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">))</span>

    <span class="k">guard</span> <span class="k">let</span> <span class="nv">value</span> <span class="o">=</span> <span class="n">optionalValue</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">optionalError</span><span class="o">!</span>
        <span class="c1">// TODO Handle error</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="c1">// Success, do something with `value`</span>
<span class="p">}</span>

<span class="c1">// Remove something</span>
<span class="n">storage</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="s">"My PIN"</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">optionalError</span> <span class="k">in</span>

    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">optionalError</span> <span class="p">{</span>
        <span class="c1">// TODO Handle error</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>A demo application is available for iOS, which utilizes the key-value storage, see <a href="https://github.com/AppPETs/Todo-iOS">Todo-iOS</a>.</p>
<h3 id='user-interactions' class='heading'>User Interactions</h3>
<h4 id='device-owner-authentication' class='heading'>Device Owner Authentication</h4>

<p>There is a convenience API to authenticate the device&rsquo;s owner. It will use Face-ID or Touch-ID if available and activated and will fall back to authenticate with the owner&rsquo;s passcode. In order to use Face-ID, add <a href="https://developer.apple.com/library/content/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html#//apple_ref/doc/uid/TP40009251-SW75"><code>NSFaceIDUsageDescription</code></a> to your <a href="https://developer.apple.com/library/content/documentation/General/Reference/InfoPlistKeyReference/Introduction/Introduction.html#//apple_ref/doc/uid/TP40009248-SW1"><code>Info.plist</code></a>.</p>
<pre class="highlight swift"><code><span class="k">var</span> <span class="nv">context</span> <span class="o">=</span> <span class="nf">authenticateDeviceOwner</span><span class="p">(</span><span class="nv">reason</span><span class="p">:</span> <span class="s">"Unlock something"</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">authenticationError</span> <span class="k">in</span>

    <span class="k">guard</span> <span class="n">authenticationError</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// Failed to authenticate (the user just might have cancelled)</span>
        <span class="c1">// TODO: Handle error</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="c1">// Successfully authenticated</span>
    <span class="nf">unlockSomething</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Invalidate context</span>
<span class="n">context</span><span class="o">.</span><span class="nf">invalidate</span><span class="p">()</span>
</code></pre>
<h4 id='confidential-qr-codes' class='heading'>Confidential QR Codes</h4>

<p>If the goal is to show a QR code on screen, but only if the device owner has authenticated himself, the <a href="https://apppets.github.io/PrivacyKit/iphone/public/Classes/ConfidentialQrCodeView.html"><code><a href="Classes/ConfidentialQrCodeView.html">ConfidentialQrCodeView</a></code></a> class can be used. This might be useful for protecting information from being displayed unaware of the device&rsquo;s owner, such as Wi-Fi credentials.</p>

<p>In order to use it, set it as a class for an image view in Interface Builder. The default image, e.g., as set in Interface Builder, of the image view, will act as cover image, which can be displayed, if the owner is not authenticated. The user can tap on the cover image, will then be asked to authenticate himself via Face-ID or Touch-ID if available and activated, and will fall back to the owner&rsquo;s passcode. If authentication succeeds the QR code, previously set, will be displayed until the user taps again.</p>
<h2 id='usage' class='heading'>Usage</h2>

<p>Assuming you have a Git repository for your project, than you can use the
<code>PrivacyKit</code> framework by adding it as a submodule:</p>
<pre class="highlight shell"><code>git submodule add https://github.com/AppPETs/PrivacyKit/issues
git submodule update <span class="nt">--init</span> <span class="nt">--recursive</span> <span class="c"># This will also fetch dependencies</span>
</code></pre>

<p>Then open your applications Xcode project and drag and drop the
<code>PrivacyKit.xcodeproj</code> into it. In the project and under Embedded Frameworks add
the <code>PrivacyKit.framework</code>.</p>

<hr>

<ol>
<li>Apple Inc., <a href="https://www.apple.com/business/docs/iOS_Security_Guide.pdf"><strong>iOS Security – iOS 11</strong></a>, 2018</li>
<li>A. Panchenko, B. Westermann, L. Pimenidis, and C. Andersson, <a href="http://dx.doi.org/10.1109/ICCCN.2009.5235258"><strong>SHALON: Lightweight Anonymization Based on Open Standards</strong></a> in <em>Proceedings of the 18th International Conference on Computer Communications and Networks, IEEE ICCCN 2009, San Francisco, California, August 3-6</em>, 2009, pp. 1–7</li>
</ol>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>&copy; 2018 <a class="link" href="https://github.com/AppPETs" target="_blank" rel="external">AppPETs</a>. All rights reserved. (Last updated: 2018-08-24)</p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.9.3</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
    </section>
  </body>
</div>
</html>
